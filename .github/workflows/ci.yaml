name: Monolith vs Microservices CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  monolith:
    name: Monolith Build & Simulated Deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: monolith
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Cache npm registry metadata
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('monolith/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install deps (strict: npm ci; fallback to npm install)
        id: install-deps
        run: |
          set -e
          echo "Working dir: $(pwd)"
          echo "Node $(node -v) / npm $(npm -v)"
          echo "Attempting strict install with 'npm ci' (requires up-to-date package-lock.json)..."
          if npm ci --prefer-offline --no-audit --no-fund; then
            echo "npm ci succeeded."
          else
            echo "================================================================"
            echo "npm ci FAILED â€” likely package-lock.json is out-of-sync with package.json"
            echo "Diagnostics: show differences and list top-level deps"
            echo "----------------------------------------------------------------"
            if [ -f package.json ]; then
              echo "package.json top-level deps:"
              node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json')); console.log(JSON.stringify({dependencies:p.dependencies, devDependencies:p.devDependencies}, null, 2));" || true
            else
              echo "No package.json found in monolith directory!"
            fi
            echo "----------------------------------------------------------------"
            echo "Local fix (run locally in repo root):"
            echo "  cd monolith && rm -rf node_modules && npm install && git add package-lock.json && git commit -m 'chore: update package-lock.json' && git push"
            echo "----------------------------------------------------------------"
            echo "Falling back to 'npm install' so the job can continue (lockfile may be updated)."
            npm install --no-audit --no-fund
            echo "NOTE: package-lock.json may have been changed. Commit the updated lockfile to fix CI permanently."
            echo "================================================================"
          fi

      - name: Unit tests (fake)
        run: npm test

      - name: Build Docker image (time it)
        id: build
        run: |
          start=$(date +%s)
          docker build -t mono-app:ci .
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Simulated deploy (time it)
        id: deploy
        run: |
          start=$(date +%s)
          echo "Simulating monolith deploy..."
          sleep 3
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### Monolith Results" >> $GITHUB_STEP_SUMMARY
          echo "- Build time: **${{ steps.build.outputs.seconds }}s**" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy time (simulated): **${{ steps.deploy.outputs.seconds }}s**" >> $GITHUB_STEP_SUMMARY

  micro:
    name: Microservices Build & Simulated Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build user-service (time it)
        id: user
        run: |
          start=$(date +%s)
          docker build -t user-service:ci microservices/user-service
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Build product-service (time it)
        id: product
        run: |
          start=$(date +%s)
          docker build -t product-service:ci microservices/product-service
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Build gateway (time it)
        id: gateway
        run: |
          start=$(date +%s)
          docker build -t gateway:ci microservices/gateway
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Simulated deploy (compose up) (time it)
        id: deploy
        run: |
          start=$(date +%s)
          echo "Simulating microservices deploy..."
          sleep 5
          end=$(date +%s)
          echo "seconds=$((end-start))" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### Microservices Results" >> $GITHUB_STEP_SUMMARY
          echo "- user-service build: **${{ steps.user.outputs.seconds }}s**" >> $GITHUB_STEP_SUMMARY
          echo "- product-service build: **${{ steps.product.outputs.seconds }}s**" >> $GITHUB_STEP_SUMMARY
          echo "- gateway build: **${{ steps.gateway.outputs.seconds }}s**" >> $GITHUB_STEP_SUMMARY
